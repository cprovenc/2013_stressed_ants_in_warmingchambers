---
title: "Will climate change cause temperature stress?"
author: "Curtis A. Provencher"
date: "2016-March-29"
output:
  pdf_document:
    toc: true
    toc_depth: 2  
---
#Rationale

###Anthropogenic warming is likely to drive shifts in phenology, distribution, and performance of species in Eastern deciduous forests.  Predicting these ecological cascades will depend on understanding how a primary seed disperser, the keystone ant genus Aphaenogaster, responds to warming. Temperatures surpassing a species’ lethal thermal limit will clearly be detrimental, but unfavorably high temperatures may impose stress substantially before that limit is reached; characterizing such sublethal responses will be vital for predicting Aphaenogaster’s future performance. Here we test for a physiological stress response in Aphaenogaster workers from a northern and southern deciduous forest under simulated climate warming.

#Experimental protocol

#loading libraries
```{r loading libraries}
library(plyr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(MASS)
```

#Loading in the data and accompanying metadata
```{r data and metadata}
# Date initiated- 4/11/2016
# Date Modified- 4/11/2016
#Affiliations- University of Vermont, University of North Carolina, Harvard Forest, Duke Forest, University of Tennessee
#Name and contact info: Curtis Provencher, cprovenc@uvm.edu, cprovenc3@gmail.com. Andrew Nguyen, adnguyen@uvm.edu, anbe642@gmail.com
#Study name: The effects of experimental warming on forest ants    
#Financial support: National Science Foundation, Division of Environmental Biology (1136644) 
#Methods of data collection: Experimental warming chamebrs set up at a northern (Harvard Forest, MA) and southern site (Duke Forest, NC) warming groud temperature up to 5.5 degrees Celsius. In 2013-2014, ants were baited in each warming chamber and three ants were collected per tube and flash frozen in the field. For each sample we isolated RNA and quantified their stress response using heat-shock proteins (hsp70, hsp83, hsp40). For housekeeping genes we quantified 18s rRNA, actin, and gapdh. Also included in this worksheet is the calculations to convert RNA to cDNA. 
#Experimental units for each variable: Collection Date(YearMonthDay), Site (HF- Harvard Forest, DF- Duke Forest), chamber(chamber number), sample(3 ants per tube),  window(area of chamber), BaitTemp(degrees Celsius), RNA conc.(ng/uL), Isolation date(Date RNA isolated, YearMonthDay), CT18s, 40, 70, 83, actin, gapdh(Threshold- 0.1, basline cycle 9-15), RIN(RNA integrity), cDNA(ng/uL), vol cDNA and H20(uL)   
#Data layout and structure:
warm<-read.csv("../Data//20160411_FinalExperimentalWarmingDataset.csv",skip=10)

```

## Quality control of expression values
```{r}
######################################################################
#Quality control
######################################################################
#ranges of gene expression
apply(warm[,14:19],2,range,na.rm=TRUE)

#filter out very lowly expressed genes
#warm.hsp70<-subset(warm,warm$CT_70<34);dim(warm.hsp70)
warm.long<-gather(warm,Genes,GXP,CT_18s:CT_83) ### converting to long format
qc.samples<-subset(warm.long,warm.long$GXP>34) ###identifying the ones that have too low expression
n.exclude<-qc.samples$n
dim(warm[-n.exclude,]) #ecluding values that are too low in expression
warm<-warm[-n.exclude,]
######################################################################
######################################################################
```

## Visualizing the properties of the dataset
```{r}
str(warm) # visualizing the properties of the dataset


#calculating # of samples per site per chamber
knitr::kable(ddply(warm,.(Site,as.factor(Cham)),summarize,num=length(n)))

#number of samples per site!
knitr::kable(ddply(warm,.(Site),summarize,num=length(n)))


###caulcating the bait temperatures!
warm$baittemp.ave<-apply(warm[,8:11],1,mean,na.rm=TRUE)
#knitr::kable(ddply(warm,.(Site),summarize,range(na.exclude(baittemp.ave))))
range(subset(warm,warm$Site=="DF")$baittemp.ave) # range of temperatures for duke forest
range(subset(warm,warm$Site=="HF")$baittemp.ave) # range of temperatures for Harvard forest

dim(warm) # looking at the dimensions...rows,columns
# number of samples for hsp70
length(na.exclude(warm$CT_70))
# number of samples for hsp83
length(na.exclude(warm$CT_83))
# number of samples for hsp40
length(na.exclude(warm$CT_40))



```

#Checking internal control
```{r}

#standard deviation in CT value for each gene
apply(warm[,14:19],2,sd,na.rm=TRUE)


#################################################
##Evaluating 18s rRNA
#################################################
hkg.mod1<-lm(warm$CT_18s~baittemp.ave*Site, data=warm)
summary(hkg.mod1)

DF<-subset(warm,warm$Site=="DF")
HF<-subset(warm,warm$Site=="HF")

plot(DF$baittemp.ave,DF$CT_18s)
plot(HF$baittemp.ave,HF$CT_18s)

#################################################

#################################################
##Evaluating actin
#################################################
hkg.mod2<-lm(warm$CT_actin~baittemp.ave*Site, data=warm)
summary(hkg.mod2)

DF<-subset(warm,warm$Site=="DF")
HF<-subset(warm,warm$Site=="HF")

plot(DF$baittemp.ave,DF$CT_actin)
plot(HF$baittemp.ave,HF$CT_actin)
#################################################

#################################################
##Evaluating gapdh
#################################################
hkg.mod3<-lm(warm$CT_gapdh~baittemp.ave*Site, data=warm)
summary(hkg.mod3)

DF<-subset(warm,warm$Site=="DF")
HF<-subset(warm,warm$Site=="HF")

plot(DF$baittemp.ave,DF$CT_gapdh)
plot(HF$baittemp.ave,HF$CT_gapdh)
#################################################



```


#Statistics
CT values themselves as measures of gene expression. The internal control was 18s rRNA

## Hsp70 regression models
```{r stats on ct values}
#getting rid of 49 
#warm<-warm[-49,]
#######################################################
#hsp70 regression model
#######################################################
hsp70.mod<-lm(CT_70~baittemp.ave*Site+RIN_Value+CT_18s,data=warm)
#summary(hsp70.mod)
summary(stepAIC(hsp70.mod,direction="backward"))

#visualizing hsp70 regression model
par(mfrow=c(2,2))
plot(stepAIC(hsp70.mod,direction="backward"))
par(mfrow=c(1,1))

```

## Hsp83 regression models
```{r}
#######################################################
#hsp83 regresssion model
#######################################################
hsp83.mod<-lm(CT_83~baittemp.ave*Site+RIN_Value+CT_18s,data=warm)
#summary(hsp83.mod)
summary(stepAIC(hsp83.mod,direction="backward"))

#visualize hsp83 model
par(mfrow=c(2,2))
plot(stepAIC(hsp83.mod,direction="backward"))
par(mfrow=c(1,1))
#######################################################
```

## Hsp40 regression models
```{r}
#######################################################
#hsp40 regression model
#######################################################
warm.40<-subset(warm,warm$CT_40!="NA" & RIN_Value !="NA")
hsp40.mod<-lm(CT_40~baittemp.ave*Site+RIN_Value+CT_18s,data=warm.40)
#summary(hsp40.mod)
summary(stepAIC(hsp40.mod,direction="both"))

par(mfrow=c(2,2))
plot(stepAIC(hsp40.mod,direction="backward"))
par(mfrow=c(1,1))
#######################################################
```




#Plotting gxp values
```{r plotting results ggplot}
#the overall theme for ggplot
T<-theme_bw()+theme(text=element_text(size=30),axis.text=element_text(size=30), panel.grid.major=element_blank(), panel.grid.minor.x = element_blank(), panel.grid = element_blank(), legend.key = element_blank(),legend.position=c(.1,.9))
```

## hsp83 plot
```{r hsp83 plot s}
ggplot(warm,aes(x=baittemp.ave,y=(1000/CT_83),colour=factor(Site)))+geom_point(size=3)+T+geom_smooth(method="lm",se=FALSE,size=3)+scale_color_manual(name="",values=c("red","blue"))+scale_x_continuous(limits=c(22,34),breaks=seq(22,34,2),"Temperature (°C)")+scale_y_continuous(limits=c(25,50),breaks=seq(25,50,5),"Hsp83 gene expression (1000/Cycle Threshold)")
```

## hsp70 plot   
```{r hsp70 plot}
ggplot(warm,aes(x=baittemp.ave,y=(1000/CT_70)))+geom_point(size=3)+T+geom_smooth(method="lm",se=FALSE,size=3)+scale_color_manual(name="",values=c("red","blue"))+scale_x_continuous(limits=c(22,34),breaks=seq(22,34,2),"Temperature (°C)")+scale_y_continuous(limits=c(25,50),breaks=seq(25,50,5),"Hsp70 gene expression (1000/Cycle Threshold)")
```

## hsp40 plot
```{r hsp40 plot}
ggplot(warm.40,aes(x=baittemp.ave,y=(1000/CT_40),colour=factor(Site)))+geom_point(size=3)+T+geom_smooth(method="lm",se=FALSE,size=3)+scale_color_manual(name="",values=c("red","blue"))+scale_x_continuous(limits=c(22,34),breaks=seq(22,34,2),"Temperature (°C)")+scale_y_continuous(limits=c(25,45),breaks=seq(25,45,5),"Hsp40 gene expression (1000/Cycle Threshold)")
ggplot(warm.40,aes(x=Site,y=(1000/CT_40)))+geom_boxplot()+T # gxp by by site

```


```{r sessioninfo}
sessionInfo()
```


